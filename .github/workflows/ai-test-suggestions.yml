name: AI Test Suggestions

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-test-suggestions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR diff
        run: |
          git fetch origin ${{ github.base_ref }} || true
          git diff origin/${{ github.base_ref }}...${{ github.head_ref }} > pr_diff.txt
          echo "Saved diff to pr_diff.txt"

      - name: Call AI service and post comment
        env:
          AI_SERVICE_URL: ${{ secrets.AI_SERVICE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python - <<'PY'
import os, requests, sys
repo = os.environ['REPO']
pr_number = os.environ['PR_NUMBER']
api_url = os.environ['AI_SERVICE_URL'].rstrip('/') + '/generate-tests'

with open('pr_diff.txt') as f:
    diff = f.read()

try:
    resp = requests.post(api_url, json={"diff": diff, "language":"python", "framework":"pytest"}, timeout=120)
except Exception as e:
    print("ERROR calling AI service:", e)
    sys.exit(1)

if resp.status_code != 200:
    print("AI service returned non-200:", resp.status_code, resp.text)
    sys.exit(1)

suggestions = resp.json().get('suggestions_markdown','')
# Truncate if too long (GitHub comments have limits)
max_len = 64000
if len(suggestions) > max_len:
    suggestions = suggestions[:max_len] + "\n\n*(truncated)*"

comment_url = f"https://api.github.com/repos/{repo}/issues/{pr_number}/comments"
r = requests.post(comment_url,
                   headers={"Authorization": f"Bearer {os.environ['GITHUB_TOKEN']}", "Accept": "application/vnd.github+json"},
                   json={"body": suggestions})
r.raise_for_status()
print("Posted comment:", r.json().get("html_url"))
PY
